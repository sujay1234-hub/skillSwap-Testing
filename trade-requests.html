<!DOCTYPE html>
<html>
<head>
<title>Trade Requests - SkillSwap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:'Inter',sans-serif;
    background:linear-gradient(135deg,#0f172a,#0b1220);
    color:white;
}

.container{
    max-width:1000px;
    margin:auto;
    padding:60px 20px;
}

h1{
    margin-bottom:40px;
    font-size:28px;
}

.card{
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(20px);
    padding:25px;
    border-radius:18px;
    margin-bottom:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    transition:0.3s;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

.card:hover{
    transform:translateY(-4px);
}

.badge{
    padding:6px 14px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
}
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 16px 22px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(16,185,129,0.5);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.4s ease;
  z-index: 9999;
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

.toast-icon {
  background: rgba(255,255,255,0.2);
  padding: 6px 10px;
  border-radius: 50%;
  font-size: 14px;
}

.hidden {
  display: none;
}

.pending{ background:#f59e0b; }
.accepted{ background:#10b981; }
.rejected{ background:#ef4444; }

.actions button{
    padding:10px 18px;
    border:none;
    border-radius:30px;
    cursor:pointer;
    font-weight:600;
    margin-left:10px;
    transition:0.2s;
}

.accept{
    background:linear-gradient(to right,#10b981,#059669);
    color:white;
}

.reject{
    background:linear-gradient(to right,#ef4444,#dc2626);
    color:white;
}

.actions button:hover{
    transform:scale(1.05);
}

</style>
</head>
<body>

<div class="container">
    <h1>Your Trade Requests</h1>
    <div id="requestsContainer"></div>
</div>

<script type="module">
import { initializeApp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  doc,
  getDoc,
  updateDoc,
  increment,
  query,
  where,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCz52XxqRB2IKCxwqm5duKJsQ2uEMs8ans",
  authDomain: "skillswapp-35e86.firebaseapp.com",
  projectId: "skillswapp-35e86",
  storageBucket: "skillswapp-35e86.appspot.com",
  messagingSenderId: "668466292157",
  appId: "1:668466292157:web:9be85414fc752b67779ed4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("requestsContainer");
function showToast(message) {
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toastMessage");

  toastMessage.innerText = message;

  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("show"), 50);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.classList.add("hidden"), 400);
  }, 3000);
}

onAuthStateChanged(auth, user => {

  if(!user){
      window.location.href = "login.html";
      return;
  }

  const q = query(
      collection(db, "tradeRequests"),
      where("ownerId", "==", user.uid)
  );

  onSnapshot(q, snapshot => {

      container.innerHTML = "";

      snapshot.forEach(docSnap => {

          const data = docSnap.data();

          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <div>
              <strong style="font-size:16px;">
                ${data.requesterName}
              </strong>
              <div style="font-size:13px;color:#94a3b8;margin-top:5px;">
                  Requested your skill exchange
              </div>
              <div style="margin-top:10px;">
                  <span class="badge ${data.status}">
                      ${data.status.toUpperCase()}
                  </span>
              </div>
            </div>

            <div class="actions">
              ${data.status === "pending" ? `
                  <button class="accept" onclick="acceptTrade('${docSnap.id}')">
                      Accept
                  </button>
                  <button class="reject" onclick="rejectTrade('${docSnap.id}')">
                      Reject
                  </button>
              ` : ""}
            </div>
          `;

          container.appendChild(card);
      });

  });

});

window.acceptTrade = async function(id){

  try {

    const tradeRef = doc(db,"tradeRequests",id);
    const tradeSnap = await getDoc(tradeRef);

    if(!tradeSnap.exists()){
        console.error("Trade not found");
        return;
    }

    const tradeData = tradeSnap.data();

    const ownerId = tradeData.ownerId;
    const requesterId = tradeData.requesterId;

    if(!ownerId || !requesterId){
        console.error("Missing user IDs");
        return;
    }

    // ‚úÖ Update request status
    await updateDoc(tradeRef,{
        status:"accepted"
    });

    // ‚úÖ Get user data
    const ownerSnap = await getDoc(doc(db,"users",ownerId));
    const requesterSnap = await getDoc(doc(db,"users",requesterId));

    const ownerName = ownerSnap.exists()
      ? ownerSnap.data().name
      : "User";

    const requesterName = requesterSnap.exists()
      ? requesterSnap.data().name
      : "User";

    // ‚úÖ CREATE ACTIVE TRADE (THIS WAS MISSING)
    await addDoc(collection(db,"trades"),{

        users:[ownerId, requesterId],

        partnerNames:{
          [ownerId]: ownerName,
          [requesterId]: requesterName
        },

        teach: tradeData.skillOffered || "",
        learn: tradeData.skillWanted || "",

        status:"active",
        createdAt: serverTimestamp()
    });

    // ‚úÖ Create chat (already working)
    const chatDoc = await addDoc(collection(db,"chats"),{
        users:[ownerId, requesterId],
        userNames:{
          [ownerId]: ownerName,
          [requesterId]: requesterName
        },
        createdAt: serverTimestamp()
    });

    showToast("Trade accepted! Visit My Trades ü§ù");

    console.log("Trade + Chat created:", chatDoc.id);

  } catch(error){
      console.error("Accept trade error:", error);
  }
};

window.rejectTrade = async function(id){
    await updateDoc(doc(db,"tradeRequests",id),{
        status:"rejected"
    });
};
</script>
<div id="toast" class="toast hidden">
  <div class="toast-icon">‚úì</div>
  <div id="toastMessage">Success</div>
</div>
</body>
</html>
